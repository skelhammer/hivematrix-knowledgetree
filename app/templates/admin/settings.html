<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Settings - KnowledgeTree</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">KnowledgeTree Admin Settings</h1>
            <div class="card__header-actions">
                <a href="{{ url_for('browse', path='') }}">
                    <button class="btn">
                        <span class="btn__label">
                            <i data-lucide="arrow-left" class="btn__icon"></i>
                            Back to Dashboard
                        </span>
                    </button>
                </a>
            </div>
        </div>
    </div>

    {# Toast container for notifications #}
    <div class="toast-container" id="toast-container"></div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Data Synchronization</h2>
        </div>
        <div class="card__body">
            <h3>Codex Sync</h3>
            <p>Synchronize company structure, users, and assets from Codex.</p>
            <button id="sync-codex-btn" class="btn btn--primary">
                <span class="btn__label">
                    <i data-lucide="database" class="btn__icon"></i>
                    Sync from Codex
                </span>
            </button>
            <div id="codex-sync-output" class="u-mt-2 u-hidden">
                <h4>Sync Output:</h4>
                <pre class="code-block"></pre>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Export/Import User Data</h2>
        </div>
        <div class="card__body">
            <h3>Export User Data</h3>
            <p>Export all user-created (non-read-only) data to a JSON file. This can be used as a backup before wiping the database.</p>
            <button id="export-data-btn" class="btn btn--primary">
                <span class="btn__label">
                    <i data-lucide="download" class="btn__icon"></i>
                    Export User Data
                </span>
            </button>

            <hr class="u-mt-4 u-mb-4">

            <h3>Import User Data</h3>
            <p>Import data from a previously exported JSON file. This will merge the data into the current database.</p>
            <input type="file" id="import-file-input" accept=".json" class="u-mb-2">
            <button id="import-data-btn" class="btn btn--primary">
                <span class="btn__label">
                    <i data-lucide="upload" class="btn__icon"></i>
                    Import User Data
                </span>
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Wipe Database</h2>
        </div>
        <div class="card__body">
            <p class="status-text status-text--danger"><strong>Warning:</strong> This will delete all data in the KnowledgeTree database.</p>
            <button id="wipe-db-btn" class="btn btn--danger">
                <span class="btn__label">
                    <i data-lucide="alert-triangle" class="btn__icon"></i>
                    Wipe Database
                </span>
            </button>
        </div>
    </div>

    <script>
        // Toast notification functions
        function dismissToast(toast) {
            toast.classList.add('toast--hiding');
            setTimeout(() => toast.remove(), 300);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            toast.onclick = () => dismissToast(toast);
            container.appendChild(toast);
            setTimeout(() => dismissToast(toast), 5000);
        }

        // Codex sync
        document.getElementById('sync-codex-btn').addEventListener('click', async () => {
            const btn = document.getElementById('sync-codex-btn');
            const output = document.getElementById('codex-sync-output');
            const pre = output.querySelector('pre');

            btn.disabled = true;
            btn.querySelector('.btn__label').innerHTML = '<i data-lucide="database" class="btn__icon"></i>Syncing...';
            lucide.createIcons();
            output.classList.remove('u-hidden');
            pre.textContent = 'Starting Codex sync...\n';

            try {
                const response = await fetch('{{ url_for("admin_sync_codex") }}', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.success) {
                    pre.textContent = data.output || 'Sync completed successfully!';
                    showToast('Codex sync completed successfully!', 'success');
                } else {
                    pre.textContent = data.error || data.message;
                    showToast('Codex sync failed. Check output for details.', 'error');
                }
            } catch (error) {
                pre.textContent = `Error: ${error.message}`;
                showToast('Failed to run Codex sync', 'error');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn__label').innerHTML = '<i data-lucide="database" class="btn__icon"></i>Sync from Codex';
                lucide.createIcons();
            }
        });

        // Wipe database
        document.getElementById('wipe-db-btn').addEventListener('click', async () => {
            if (!confirm('Are you ABSOLUTELY SURE you want to wipe the entire database? This cannot be undone!')) {
                return;
            }
            if (!confirm('Last chance! Type YES in the next prompt to confirm.')) {
                return;
            }
            const confirmation = prompt('Type YES to confirm database wipe:');
            if (confirmation !== 'YES') {
                alert('Database wipe cancelled.');
                return;
            }

            try {
                const response = await fetch('{{ url_for("admin_wipe") }}', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Database wiped successfully!', 'success');
                    window.location.href = '{{ url_for("browse", path="") }}';
                } else {
                    showToast('Failed to wipe database', 'error');
                }
            } catch (error) {
                showToast('Error wiping database', 'error');
            }
        });

        // Export data
        document.getElementById('export-data-btn').addEventListener('click', async () => {
            window.location.href = '{{ url_for("admin_export") }}';
        });

        // Import data
        document.getElementById('import-data-btn').addEventListener('click', async () => {
            const file = document.getElementById('import-file-input').files[0];
            if (!file) {
                showToast('Please select a file to import', 'error');
                return;
            }
            const confirmation = confirm('Are you sure you want to import this data? This may overwrite existing user-created content.');
            if (!confirmation) {
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const btn = document.getElementById('import-data-btn');
            btn.disabled = true;
            btn.querySelector('.btn__label').innerHTML = '<i data-lucide="upload" class="btn__icon"></i>Importing...';
            lucide.createIcons();

            try {
                const response = await fetch('{{ url_for("admin_import") }}', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Import successful!', 'success');
                    window.location.reload();
                } else {
                    showToast(`Import error: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`Network error: ${error}`, 'error');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn__label').innerHTML = '<i data-lucide="upload" class="btn__icon"></i>Import User Data';
                lucide.createIcons();
            }
        });

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
    <div class="version-footer">
        <span class="version-footer__text">{{ app_service_name }} v{{ app_version }}</span>
    </div>
</body>
</html>
